<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="index.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<div id="container">
    <header>
        <div class="col">
            <img style="height: 40px;padding-left:10%" src="data/logo_04.png">
        </div>
        <div class="col middle">
            <span style="font-size: 35px;color: aliceblue">网络监测数据可视化</span><br>
            <span style="font-size: 14px;color: aliceblue">Visualization of Network Monitoring Data </span>
        </div>
        <div class="col">
            <p style="color: aliceblue;font-size: 13px; height:30px;width: 100% ;text-align: center; " id="show">
        </div>
    </header>
    <div class="content">
        <div class="left">
            <div class="world_map">
                <table style="width: 100%;height: 100%">
                    <tr>
                        <td style="width: 10%"></td>
                        <td style="width: 80%">
                            <div id="map" style="width:100%;height: 100%"></div>
                        </td>
                        <td style="width: 20%"></td>
                    </tr>
                </table>

            </div>
            <div class="list_show">
                <table style="width: 100%;height: 100%">
                    <tr style="height: 50%">
                        <td style="width: 50%">
                            <div id="filechart" style="width:90%;height: 90%"></div>
                        </td>
                        <td>
                            <div id="database" style="width:90%;height: 90%"></div>
                        </td>
                    </tr>
                    <tr style="height: 50%">
                        <td>
                            <div id="httpem" style="width:90%;height: 90%"></div>
                        </td>
                        <td>
                            <div id="ssh" style="width:90%;height: 90%"></div>
                        </td>
                    </tr>
                </table>

            </div>
        </div>
        <div class="right">
            <div class="text_show" style="display: table;">
                <div style="width: 30%;height: 100%;display: table-cell; background-color: gray;">

                </div>
                <div style="width: 30%;height: 100%;display: table-cell;background-color: #2c4755">

                </div>
                <div style="width: 30%;height: 100%;display: table-cell;background-color: green">

                </div>
            </div>
            <div class="list_statistics" style="display: table">
                <div id="baseproportion" style="width:25%;height: 80%;display: table-cell"></div>
                <div id="wordsproportion" style="width:40%;height: 90%;display: table-cell"></div>
            </div>
            <div class="operation"></div>
        </div>
    </div>
    <footer>
        <div class="col">
        </div>
        <div class="col middle">
            <span style="font-size: 14px;color: aliceblue">copyright© 2018 www.crabapple.xyz</span>
        </div>
        <div class="col">
        </div>
    </footer>
</div>
<script type="text/javascript" src="js/lib/echarts.js"></script>
<script type="text/javascript" src="js/lib/echarts-gl.js"></script>
<script src="js/lib/mapbox-gl.js"></script>
<script src='js/lib/echarts-wordcloud.js'></script>
<script src="js/basechart.js"></script>
<script src="js/statisticchart.js"></script>
<script src="js/crabapple.js"></script>
<script src="js/home.js"></script>
<script>

    mapboxgl.accessToken = 'pk.eyJ1IjoiY3JhYmFwcGxlIiwiYSI6ImNqb2xmYXpiczA5OTMzcXRocXBsdnppdTQifQ.jS_2o9Tpidr0wDI07TRj7Q';
    var myChart = echarts.init(document.getElementById('map'));

    var myguiji=[
        {'coords':[[104.69588,31.53709],[121.53504, 38.889698]],'lineStyle':{ color: '#397aff'}},
        {'coords':[[104.69588,31.53709],[-77.4874416, 39.0437567]],'lineStyle':{ color: '#ff1122'}},
        {'coords':[[104.69588,31.53709],[ 121.53504,30.889698 ]],'lineStyle':{ color: '#52ff45'}},
        {'coords':[[104.69588,31.53709],[ 101.53504,10.889698 ]],'lineStyle':{ color: '#397aff'}},
        {'coords':[[104.69588,31.53709],[ -21.53504,60.889698 ]],'lineStyle':{ color: '#ff1e1a'}}
    ]
    //地图基本参数设置
    var mapdata={
        mapbox: {
            center: [30,40],
            zoom: 1,
            //pitch: 50,
            //bearing: -10,
            altitudeScale: 1,
            style: 'mapbox://styles/mapbox/dark-v9',
            postEffect: {
                enable: true,
                SSAO: {
                    enable: true,
                    radius: 2,
                    intensity: 1.5
                }
            },
            light: {
                main: {
                    intensity: 0.1,
                    shadow: true,
                    shadowQuality: 'high'
                },
                ambient: {
                    intensity: 0.
                },
                ambientCubemap: {
                    exposure: 1,
                    diffuseIntensity: 0.5
                }
            }
        },
        series: [{
            type: 'lines3D',
            coordinateSystem: 'mapbox',
            effect: {
                show: true,
                period:1,
                constantSpeed: 1,
                trailWidth: 1,
                trailLength: 0.1,
                trailOpacity: 1,
                spotIntensity: 4
            },
            blendMode: 'lighter',
            polyline: true,
            lineStyle: {
                width: 0.1,
                color: '#397aff',   //'rgb(200, 40, 0)',
                opacity: 0
            },
            data:myguiji
        }]
    }

    //myChart.setOption(mapdata);

    var filechart = echarts.init(document.getElementById('filechart'));
    var databasechart = echarts.init(document.getElementById('database'));
    var httpemchart = echarts.init(document.getElementById('httpem'));
    var sshchart = echarts.init(document.getElementById('ssh'));

    filechart.setOption(fileData)
    databasechart.setOption(databaseData)
    httpemchart.setOption(httpemData)
    sshchart.setOption(sshData)

    offset=70
    function loadXMLDoc()
    {
        var xmlhttp;
        if (window.XMLHttpRequest)
        {
            // IE7+, Firefox, Chrome, Opera, Safari 浏览器执行代码
            xmlhttp=new XMLHttpRequest();
        }
        else
        {
            // IE6, IE5 浏览器执行代码
            xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
        }
        xmlhttp.onreadystatechange=function()
        {
            if (xmlhttp.readyState==4 && xmlhttp.status==200)
            {
                redata=JSON.parse(xmlhttp.responseText);
                mapdata['series'][0]['data']=redata['toplace'];
                myChart.setOption(mapdata);
                console.log(redata)
                console.log(redata['toplace'])

                updateTimeArray(offset-1)

                //file chart
                let upd=fileData['series'][0]['data']
                let downd=fileData['series'][1]['data']
                for(let i=0;i<upd.length-1;i++){
                    upd[i]=upd[i+1]
                    downd[i]=downd[i+1]
                }
                upd[upd.length-1]=redata['base']['file']['upload']
                downd[upd.length-1]=redata['base']['file']['download']
                fileData['series'][0]['data']=upd
                fileData['series'][1]['data']=downd
                filechart.setOption(fileData)


                // databaseData=JSON.parse(fileData.toString())
                // httpemData=JSON.parse(fileData.toString())
                // sshData=JSON.parse(fileData.toString())

                //database chart
                upd=databaseData['series'][0]['data']
                downd=databaseData['series'][1]['data']
                for(let i=0;i<upd.length-1;i++){
                    upd[i]=upd[i+1]
                    downd[i]=downd[i+1]
                }
                upd[upd.length-1]=redata['base']['database']['upload']
                downd[upd.length-1]=redata['base']['database']['download']
                databaseData['series'][0]['data']=upd
                databaseData['series'][1]['data']=downd
                databasechart.setOption(databaseData)

                //http email chart
                upd=httpemData['series'][0]['data']
                downd=httpemData['series'][1]['data']
                for(let i=0;i<upd.length-1;i++){
                    upd[i]=upd[i+1]
                    downd[i]=downd[i+1]
                }
                upd[upd.length-1]=redata['base']['http']['upload']
                downd[upd.length-1]=redata['base']['http']['download']
                httpemData['series'][0]['data']=upd
                httpemData['series'][1]['data']=downd
                upd=httpemData['series'][2]['data']
                downd=httpemData['series'][3]['data']
                for(let i=0;i<upd.length-1;i++){
                    upd[i]=upd[i+1]
                    downd[i]=downd[i+1]
                }
                upd[upd.length-1]=redata['base']['email']['upload']
                downd[upd.length-1]=redata['base']['email']['download']
                httpemData['series'][2]['data']=upd
                httpemData['series'][3]['data']=downd
                httpemchart.setOption(httpemData)


                //ssh chart
                upd=sshData['series'][0]['data']
                downd=sshData['series'][1]['data']
                for(let i=0;i<upd.length-1;i++){
                    upd[i]=upd[i+1]
                    downd[i]=downd[i+1]
                }
                upd[upd.length-1]=redata['base']['ssh']['upload']
                downd[upd.length-1]=redata['base']['ssh']['download']
                sshData['series'][0]['data']=upd
                sshData['series'][1]['data']=downd
                sshchart.setOption(sshData)

            }
        }




        xmlhttp.open("POST","http://127.0.0.1:5000/tcp",true);
        xmlhttp.setRequestHeader('Content-Type','application/json')
        xmlhttp.send(JSON.stringify({"day":1,"offset":offset}));
        offset++
       // setTimeout(loadXMLDoc, 4000);
    }

    loadXMLDoc()


    window.onload = function() {
        var show = document.getElementById("show");
        setInterval(function() {
            var time = new Date();   // 程序计时的月从0开始取值后+1
            var m = time.getMonth() + 1;
            var t = time.getFullYear() + "-" + m + "-"
                + time.getDate() + " " + time.getHours() + ":"
                + time.getMinutes() + ":" + time.getSeconds();
            show.innerHTML = t;
        }, 1000);
    };

</script>
</body>
</html>